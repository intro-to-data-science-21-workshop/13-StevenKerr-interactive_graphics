---
title: "Interactive Plotting with Plotly in R"
author: "Steve Kerr & Julian Kath"
institute: "Hertie School"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    df_print: paged
    number_sections: FALSE
    highlight: tango
    theme: lumen
    toc_depth: 3
    toc_float: true
    css: custom.css 
    self_contained: false
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```
***

Welcome to **plotly**! plotly is an R package for creating **interactive** and **dynamic** **web-based** graphics.  

What we will cover:

* installing plotly
* ggplot vs. plotly syntax 
* using ggplotly
* plotly examples
* Q&A

# Install  `r emo::ji("man_technologist")`

```{r install, eval=TRUE, message=FALSE, warning=FALSE, results='hide'}
# Download from CRAN
install.packages('plotly', repos = 'http://cran.us.r-project.org')

# Download from GitHub
devtools::install_github("ropensci/plotly")

# load plotly
library(plotly)
```

# ggplot2 vs. plotly

Last week we learned about ggplot2's grammar of graphics. Here we'll examine how plotly's syntax differs from that of ggplot2. 

## ggplot2

Let's quickly recap ggplot2's grammar of graphics. In most cases you start with ggplot( ), supply a data set and aesthetic mapping (with aes( )). You then add on layers (e.g., geom_point( ) or geom_histogram( )), scales (e.g., scale_colour_brewer( )), faceting specifications (e.g., facet_wrap( )) and coordinate systems (e.g., coord_flip( )).
[(more info)](https://ggplot2.tidyverse.org/)


Here's the template for building plots with ggplot2:
```
ggplot(data = <DATA>) + 
  <GEOM_FUNCTION>(
     mapping = aes(<MAPPINGS>),
     stat = <STAT>, 
     position = <POSITION>
  ) +
  <COORDINATE_FUNCTION> +
  <FACET_FUNCTION>
```


Here's an example of ggplot2 in action:
```{r ggplot2, fig.align='center'}
library(ggplot2)

ggplot(iris) + # Add data
  geom_point(
    mapping = aes(x = Petal.Length, y = Sepal.Length, color = Species)) + # Add mappings
  labs(title = "Petal vs. Sepal Lengths", # Add title & labels
       x = "Petal Length", 
       y = "Sepal Length",
       color = "Species") + # Add legend title
  theme_minimal() # Add theme
```

## plotly 

The grammar of plotly is similar to that of ggplot2. Like ggplot2, you start with a base and add layers. 

### Trace 

In plotly, the base is referred to as a "trace." A trace defines a mapping from data and visuals. Every trace has a type (e.g., histogram, pie, scatter, etc) and the trace type determines what other attributes (i.e., visual and/or interactive properties, like x, hoverinfo, name) are available to control the trace mapping.

To add a layer in the graph, such as fitting a linear regression line, we use **add_trace()**. There is also a family of **add_*( )** functions (e.g., add_histogram( ), add_lines( ), etc) that define how to render data into geometric objects. [(more info)](https://jtr13.github.io/spring19/community_contribution_group17.html)

List of **add_*( )** functions:

* add_histograms( )
* add_bars( )
* add_boxplot( )
* add_contour( )
* add_lines( )
* add_heatmap( )
* add_scattergeo( )
* add_pie( )
* and many more...

### Layout

The layout( ) function adds and modifies parts of the plotly graphic. This includes modifying the plot title, legend, margins, size, font, background color, colorscale, and hoverlabels among other features.  

Here's how you would create the plot from above using plotly:  
```{r plotly, fig.align='center'}
library(plotly)

iris %>% # Add data
  # NOTE: plotly works with pipe operators (%>%)
  plot_ly(x = ~Petal.Length, y = ~Sepal.Length, split = ~Species, # Add mappings
  # NOTE: You will need to use ~ to map a variable of the data set to an aesthetic parameter
        type = 'scatter') %>% # Specify trace type 
  layout(title = 'Petal vs. Sepal Length', # Add title & labels
         xaxis = list(title = 'Petal Length'),
         yaxis = list(title = 'Sepal Length'),          
         legend = list(title = list(text = 'Species')), # Add legend title
         plot_bgcolor = 'white') # Modify background color 
```

Notice that even while the plots look quite similar, the syntax we use to create them can be quite different.


To underscore this point, the table below shows the differences in ggplot2 and plotly grammar: 

| Element 	| ggplot2 	| plotly 	|
|---    |---	|---	|
| Data & Aesthetics	| `ggplot(data = mpg, aes(x = displ, y = hwy, color = drv))` 	| `plot_ly(data = mpg, x = ~displ, y = ~hwy, color = ~drv)` |
| Geometries 	| `+ geom_point()` 	| `%>% add_markers()` |
| Facets 	| `+ facet_grid(vars(drv), ncol = 1)` 	| `%>% subplot(fig1, fig2)` or use `ggplotly()` |
| Labels 	| `+ labs(x = "Height", y = "Weight", title = "Look at my plot")`	| ` %>% layout(title = 'Look at my plot', xaxis = list(title = 'Height'), yaxis = list(title = 'Weight')` |

### schema( )

It's not easy learning an entirely new grammar of graphics. Thankfully the schema( ) function is a helpful resource! The schema contains valid attributes names, their value type, default values (if any), and min/max values (if applicable). [(more info)](https://www.rdocumentation.org/packages/plotly/versions/4.10.0/topics/schema)

```{r schema}
# Try it! 
schema()
```

# ggplotly 

The ggplotly( ) function has the ability to translate ggplot2 to plotly. This functionality can be really helpful for quickly adding interactivity to your existing ggplot2 workflow. Moreover, even if you know plotly well, you can still leverage ggplot2â€™s consistent and expressive interface for exploring statistical summaries across groups. [(more info)](https://plotly-r.com/overview.html#intro-ggplotly)

To use ggplotly function, plot a regular ggplot2 graphic and then apply the ggplotly( ) function. 
```{r ggplotly, message=FALSE, warning=FALSE, fig.align='center'}}
library(ggplot2)
library(plotly)

g <- ggplot(iris) + # Add data
  geom_point(
    mapping = aes(x = Petal.Length, y = Sepal.Length, color = Species), # Add mappings
    position = position_jitter()) + # Modify position
  labs(title = "Petal vs. Sepal Lengths",
       x = "Petal Length", # Add title & labels
       y = "Sepal Length",
       color = "Species") + # Add legend title
  theme_minimal() + # Add theme
  theme(legend.position = "right") # Adjust legend position
  
ggplotly(g)
```

# Key Features

```{r}
# the `plot_ly()` function initiates an object, and if no trace type
# is specified, it sets a sensible default
p <- plot_ly(economics, x = ~date, y = ~uempmed)
p
# some `add_*()` functions are a specific case of a trace type
# for example, `add_markers()` is a scatter trace with mode of markers
add_markers(p)
# scatter trace with mode of text
add_text(p, text = "%")
# scatter trace with mode of lines
add_paths(p)
# like `add_paths()`, but ensures points are connected according to `x`
add_lines(p)
# if you prefer to work with plotly.js more directly, can always
# use `add_trace()` and specify the type yourself
add_trace(p, type = "scatter", mode = "markers+lines")
# mappings provided to `plot_ly()` are "global", but can be overwritten
plot_ly(economics, x = ~date, y = ~uempmed, color = I("red"), showlegend = FALSE) %>%
add_lines() %>%
add_markers(color = ~pop)

# a number of `add_*()` functions are special cases of the scatter trace
plot_ly(economics, x = ~date) %>%
add_ribbons(ymin = ~pce - 1e3, ymax = ~pce + 1e3)
# use `group_by()` (or `group2NA()`) to apply visual mapping
# once per group (e.g. one line per group)
txhousing %>%
group_by(city) %>%
plot_ly(x = ~date, y = ~median) %>%
add_lines(color = I("black"))
## Not run:
# use `add_sf()` or `add_polygons()` to create geo-spatial maps
# http://blog.cpsievert.me/2018/03/30/visualizing-geo-spatial-data-with-sf-and-plotly/
if (requireNamespace("sf", quietly = TRUE)) {
nc <- sf::st_read(system.file("shape/nc.shp", package = "sf"), quiet = TRUE)
plot_ly() %>% add_sf(data = nc)
}
# univariate summary statistics
plot_ly(mtcars, x = ~factor(vs), y = ~mpg) %>%
add_boxplot()
plot_ly(mtcars, x = ~factor(vs), y = ~mpg) %>%
add_trace(type = "violin")
# `add_histogram()` does binning for you...
mtcars %>%
plot_ly(x = ~factor(vs)) %>%
add_histogram()
# ...but you can 'pre-compute' bar heights in R
mtcars %>%
dplyr::count(vs) %>%
plot_ly(x = ~vs, y = ~n) %>%
add_bars()
# the 2d analogy of add_histogram() is add_histogram2d()/add_histogram2dcontour()
library(MASS)
(p <- plot_ly(geyser, x = ~waiting, y = ~duration))
add_histogram2d(p)
add_histogram2dcontour(p)
# the 2d analogy of add_bars() is add_heatmap()/add_contour()
# (i.e., bin counts must be pre-specified)
den <- kde2d(geyser$waiting, geyser$duration)
p <- plot_ly(x = den$x, y = den$y, z = den$z)
add_heatmap(p)
add_contour(p)
# `add_table()` makes it easy to map a data frame to the table trace type
plot_ly(economics) %>%
add_table()

# pie charts!
ds <- data.frame(labels = c("A", "B", "C"), values = c(10, 40, 60))
plot_ly(ds, labels = ~labels, values = ~values) %>%
add_pie() %>%
layout(title = "Basic Pie Chart using Plotly")
data(wind)
plot_ly(wind, r = ~r, t = ~t) %>%
add_area(color = ~nms) %>%
layout(radialaxis = list(ticksuffix = "%"), orientation = 270)
# ------------------------------------------------------------
# 3D chart types
# ------------------------------------------------------------
plot_ly(z = ~volcano) %>%
add_surface()
plot_ly(x = c(0, 0, 1), y = c(0, 1, 0), z = c(0, 0, 0)) %>%
add_mesh()
```


```{r}
diamonds %>%
  plot_ly() %>% 
  add_histogram(x = ~cut)
```

The type of plot is specified by setting the trace type. The scatter trace type is the foundation for many low-level geometries (e.g., points, lines, and text), thus we must also specify a mode. To create a scatter plot with points the mode is set to markers, but additional scatter modes include lines, paths, segments, ribbons, polygons, and text.
(https://blog.methodsconsultants.com/posts/introduction-to-interactive-graphics-in-r-with-plotly/)

```{r}
mpg %>%
  plot_ly(x = ~displ, y = ~hwy, color = ~class)
```

```{r}
mpg %>%
  plot_ly(x = ~displ, y = ~hwy, color = ~class) %>%
  add_trace(type = "scatter", mode = "markers")
```

Rather than using add_trace() and specifying the type and mode, we can use the convenience function add_markers(). (https://blog.methodsconsultants.com/posts/introduction-to-interactive-graphics-in-r-with-plotly/)

```{r}
mpg %>%
  plot_ly(x = ~displ, y = ~hwy, color = ~class) %>%
  add_markers()
```





# Q&A 

```{r, fig.align='center', echo=FALSE, out.width = "90%"}
knitr::include_graphics("pics/questions.png")
```

# Sources

This tutorial drew from the following sources:
* [A Comparison of plot_ly and ggplotly for Interactive Graphs in R](https://jtr13.github.io/spring19/community_contribution_group17.html)
* (https://ggplot2.tidyverse.org/)
* (https://r4ds.had.co.nz/data-visualisation.html)
* (https://plotly-r.com/overview.html)
* (https://cran.r-project.org/web/packages/plotly/plotly.pdf)

We also used an [example](https://towardsdatascience.com/tidy-web-scraping-in-r-tutorial-and-resources-ac9f72b4fe47) from Keith McNulty's blog post on tidy web scraping in R.

[example](https://jtr13.github.io/spring19/community_contribution_group17.html)
